#!/bin/bash

# Pre-commit hook to prevent committing sensitive data

# Colors
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "ğŸ” Checking for sensitive data..."

FILES=$(git diff --cached --name-only --diff-filter=ACM)

IP_PATTERN='[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}'

EXCLUDE_PATTERNS=(
  "examples/sdk-demo/"
  "examples/postgres-test/"
  ".github/"
  "README.md"
  "CHANGELOG.md"
)

FOUND_ISSUES=0

for FILE in $FILES; do
  SKIP=0
  for EXCLUDE in "${EXCLUDE_PATTERNS[@]}"; do
    if [[ "$FILE" == *"$EXCLUDE"* ]]; then
      SKIP=1
      break
    fi
  done

  if [ $SKIP -eq 1 ]; then
    continue
  fi

  if git diff --cached "$FILE" | grep -E "$IP_PATTERN" | grep -v "127.0.0.1" | grep -v "0.0.0.0" | grep -v "localhost" > /dev/null; then
    echo -e "${RED}âŒ Found IP address in: $FILE${NC}"
    FOUND_ISSUES=1
  fi
done

if [ $FOUND_ISSUES -eq 1 ]; then
  echo ""
  echo -e "${RED}ğŸš« COMMIT BLOCKED - Sensitive data detected!${NC}"
  echo ""
  exit 1
fi

echo "âœ… No sensitive data detected"
exit 0
